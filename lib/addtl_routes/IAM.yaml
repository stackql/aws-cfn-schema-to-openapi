openapi: 3.0.0
info:
  title: IAM
  description: Additional stackql views for IAM
  version: 1.0.0
paths: {}
components:
  schemas:
    region:
      type: string
      description: The AWS region (always `us-east-1` for IAM resources)
    user_policies:
      description: List of user policies by UserName (requires `aws` provider to be installed)
      type: object
      additionalProperties: false
      properties:
        UserName:
          type: string
          description: The IAM user name
        member:
          type: string
          description: The user policy name
        region:
          $ref: '#/components/schemas/region'
      x-example-where-clause: WHERE UserName = '<UserName>'
    group_policies:
      description: List of group policies by GroupName (requires `aws` provider to be installed)
      type: object
      additionalProperties: false
      properties:
        GroupName:
          type: string
          description: The IAM group name
        PolicyName:
          type: string
          description: The group policy name
        PolicyDocument:
          type: string
          description: The group policy document          
        region:
          $ref: '#/components/schemas/region'
      x-example-where-clause: WHERE GroupName = '<GroupName>'
    role_policies:
      description: List of policies by RoleName (requires `aws` provider to be installed)
      type: object
      additionalProperties: false
      properties:
        RoleName:
          type: string
          description: The IAM role name
        PolicyName:
          type: string
          description: The role policy name
        PolicyDocument:
          type: string
          description: The role policy document          
        region:
          $ref: '#/components/schemas/region'
      x-example-where-clause: WHERE RoleName = '<RoleName>'      
    policies:
      description: List of policies (requires `aws` provider to be installed)
      type: object
      additionalProperties: false
      properties:
        PolicyName:
          type: string
          description: The name for the policy
        Arn:
          type: string
          description: The ARN
        AttachmentCount:
          type: number
          description: The attachment count for the policy
        CreateDate:
          type: string
          description: The creation date for the policy
        DefaultVersionId:
          type: string
          description: The default version id for the policy
        Description:
          type: string
          description: The description for the policy
        IsAttachable:
          type: boolean
          description: Is the policy attachable?
        Path:
          type: string
          description: The path for the policy
        PermissionsBoundaryUsageCount:
          type: number
          description: The permissions boundary usage count for the policy 
        PolicyId:
          type: string
          description: The id for the policy
        Tags:
          type: array
          description: Tags for the policy
        UpdateDate:
          type: string
          description: The update date for the policy
        region:
          $ref: '#/components/schemas/region'
      x-example-where-clause: ''        
  x-stackQL-resources:
    user_policies:
      name: user_policies
      id: aws.iam.user_policies
      x-cfn-schema-name: user_policies
      x-type: custom_list
      config:
        views:
          select:
            predicate: sqlDialect == "sqlite3"
            ddl: |-
              SELECT
              UserName,
              member,
              region
              FROM aws.iam_api.user_policies
              WHERE UserName = '<UserName>'
              AND region = 'us-east-1'
    group_policies:
      name: group_policies
      id: aws.iam.group_policies
      x-cfn-schema-name: group_policies
      x-type: custom_list
      config:
        views:
          select:
            predicate: sqlDialect == "sqlite3"
            ddl: |-
              SELECT
              GroupName,
              PolicyName,
              PolicyDocument,
              region
              FROM aws.iam_api.group_policies
              WHERE GroupName = '<GroupName>'
              AND region = 'us-east-1'
    policies:
      name: policies
      id: aws.iam.policies
      x-cfn-schema-name: policies
      x-type: custom_list
      config:
        views:
          select:
            predicate: sqlDialect == "sqlite3"
            ddl: |-
              SELECT
              PolicyName,
              Arn,
              AttachmentCount,
              CreateDate,
              DefaultVersionId,
              Description,
              IsAttachable,
              Path,
              PermissionsBoundaryUsageCount,
              PolicyId,
              Tags,
              UpdateDate,
              region
              FROM aws.iam_api.policies
              WHERE region = 'us-east-1'
    role_policies:
      name: role_policies
      id: aws.iam.role_policies
      x-cfn-schema-name: role_policies
      x-type: custom_list
      config:
        views:
          select:
            predicate: sqlDialect == "sqlite3"
            ddl: |-
              SELECT
              RoleName,
              PolicyName,
              PolicyDocument,
              region
              FROM aws.iam_api.role_policies
              WHERE RoleName = '<RoleName>'
              AND region = 'us-east-1'
